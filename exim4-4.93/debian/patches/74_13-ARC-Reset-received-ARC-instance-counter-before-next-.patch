From 0445bf5044cafd376d9d788bbf7551e21411a8e6 Mon Sep 17 00:00:00 2001
From: Jeremy Harris <jgh146exb@wizmail.org>
Date: Tue, 17 Dec 2019 10:46:21 +0000
Subject: [PATCH 13/13]     ARC: Reset received ARC instance counter before
 next message on a connection.  Bug 2498

(cherry picked from commit 1415d1a6c91e66922036079b3e3b481e579cdb00)
---
 doc/ChangeLog | 5 +++++
 src/smtp_in.c     | 1 +
 2 files changed, 6 insertions(+)

diff --git a/doc/ChangeLog b/doc/ChangeLog
index de6166d8e..812546e8c 100644
--- a/doc/ChangeLog
+++ b/doc/ChangeLog
@@ -35,6 +35,11 @@ JH/11 Bug 2494: Unset the default for dmarc_tld_file.  Previously a naiive
 JH/12 Fix an uninitialised flag in early-pipelining.  Previously connections
       could, depending on the platform, hang at the STARTTLS response.
 
+JH/13 Bug 2498: Reset a counter used for ARC verify before handling another
+      message on a connection.  Previously if one message had ARC headers and
+      the following one did not, a crash could result when adding an
+      Authentication-Results: header.
+
 
 Exim version 4.93
 -----------------
diff --git a/src/smtp_in.c b/src/smtp_in.c
index f37b2f6e0..d0fb6b81c 100644
--- a/src/smtp_in.c
+++ b/src/smtp_in.c
@@ -2087,6 +2087,7 @@ dmarc_used_domain = NULL;
 #endif
 #ifdef EXPERIMENTAL_ARC
 arc_state = arc_state_reason = NULL;
+arc_received_instance = 0;
 #endif
 dsn_ret = 0;
 dsn_envid = NULL;
-- 
2.24.0

