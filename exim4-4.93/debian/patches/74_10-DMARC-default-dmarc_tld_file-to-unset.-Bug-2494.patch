From 134c037ed24f77957556f40856659c1456df1bcc Mon Sep 17 00:00:00 2001
From: Jeremy Harris <jgh146exb@wizmail.org>
Date: Fri, 13 Dec 2019 14:26:17 +0000
Subject: [PATCH 10/13] DMARC: default dmarc_tld_file to unset.  Bug 2494

(cherry picked from commit 39fdec3c4a4b4c1cc60cd17413b096dd07344734)
---
 doc/doc-docbook/spec.xfpt | 5 ++++-
 doc/ChangeLog     | 6 ++++++
 src/globals.c         | 2 +-
 src/receive.c         | 8 ++------
 4 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/doc/ChangeLog b/doc/ChangeLog
index b231a3f75..8e096face 100644
--- a/doc/ChangeLog
+++ b/doc/ChangeLog
@@ -26,6 +26,12 @@ JH/10 Bug 2492: Use tainted memory for retry record when needed.  Previously whe
       a new record was being constructed with information from the peer, a trap
       was taken.
 
+JH/11 Bug 2494: Unset the default for dmarc_tld_file.  Previously a naiive
+      installation would get error messages from DMARC verify, when it hit the
+      nonexistent file indicated by the default.  Distros wanting DMARC enabled
+      should both provide the file and set the option.
+      Also enforce no DMARC verification for command-line sourced messages.
+
 
 Exim version 4.93
 -----------------
diff --git a/src/globals.c b/src/globals.c
index 358c380a8..85a25a7f2 100644
--- a/src/globals.c
+++ b/src/globals.c
@@ -844,7 +844,7 @@ uschar *dmarc_forensic_sender   = NULL;
 uschar *dmarc_history_file      = NULL;
 uschar *dmarc_status            = NULL;
 uschar *dmarc_status_text       = NULL;
-uschar *dmarc_tld_file          = US DMARC_TLD_FILE;
+uschar *dmarc_tld_file          = NULL;
 uschar *dmarc_used_domain       = NULL;
 #endif
 
diff --git a/src/receive.c b/src/receive.c
index 31e3f7cbb..4e85ffacf 100644
--- a/src/receive.c
+++ b/src/receive.c
@@ -1703,10 +1703,6 @@ header_line *msgid_header = NULL;
 header_line *received_header;
 BOOL msgid_header_newly_created = FALSE;
 
-#ifdef SUPPORT_DMARC
-int dmarc_up = 0;
-#endif
-
 /* Variables for use when building the Received: header. */
 
 uschar *timestamp;
@@ -1768,7 +1764,7 @@ if (smtp_input && !smtp_batched_input && !f.dkim_disable_verify)
 #endif
 
 #ifdef SUPPORT_DMARC
-dmarc_up = dmarc_init();	/* initialize libopendmarc */
+if (sender_host_address) dmarc_init();	/* initialize libopendmarc */
 #endif
 
 /* Remember the time of reception. Exim uses time+pid for uniqueness of message
@@ -3499,7 +3495,7 @@ else
 #endif /* WITH_CONTENT_SCAN */
 
 #ifdef SUPPORT_DMARC
-    dmarc_up = dmarc_store_data(from_header);
+    dmarc_store_data(from_header);
 #endif
 
 #ifndef DISABLE_PRDR
-- 
2.24.0

