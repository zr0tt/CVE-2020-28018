From 8d844fbac46c4dcafd507d66b497a537581f0994 Mon Sep 17 00:00:00 2001
From: Jeremy Harris <jgh146exb@wizmail.org>
Date: Thu, 5 Mar 2020 19:45:04 +0000
Subject: [PATCH 31/33]     Taint: track in ${utf8clean:} operator

    (cherry picked from commit e68def51cb753d730249565e630b549a73857ec1)
---
 src/expand.c    | 16 +++++++++++++---
 src/functions.h | 12 ++++++++++++
 src/string.c    | 11 -----------
 3 files changed, 25 insertions(+), 14 deletions(-)

diff --git a/src/expand.c b/src/expand.c
index dea26494a..f489c5b8b 100644
--- a/src/expand.c
+++ b/src/expand.c
@@ -7422,10 +7422,10 @@ while (*s != 0)
 
       case EOP_FROM_UTF8:
         {
-        while (*sub != 0)
+	uschar * buff = store_get(4, is_tainted(sub));
+        while (*sub)
           {
           int c;
-          uschar buff[4];
           GETUTF8INC(c, sub);
           if (c > 255) c = '_';
           buff[0] = c;
@@ -7446,7 +7446,17 @@ while (*s != 0)
         int complete;
         uschar seq_buff[4];			/* accumulate utf-8 here */
 
-        while (*sub != 0)
+	/* Manually track tainting, as we deal in individual chars below */
+
+	if (is_tainted(sub))
+	  if (yield->s && yield->ptr)
+	    gstring_rebuffer(yield);
+	  else
+	    yield->s = store_get(yield->size = Ustrlen(sub), TRUE);
+
+	/* Check the UTF-8, byte-by-byte */
+
+        while (*sub)
 	  {
 	  complete = 0;
 	  uschar c = *sub++;
diff --git a/src/functions.h b/src/functions.h
index af633851b..a1dab5db0 100644
--- a/src/functions.h
+++ b/src/functions.h
@@ -902,6 +902,18 @@ va_end(ap);
 return g;
 }
 
+
+/* Copy the content of a string to tainted memory */
+
+static inline void
+gstring_rebuffer(gstring * g)
+{
+uschar * s = store_get(g->size, TRUE);
+memcpy(s, g->s, g->ptr);
+g->s = s;
+}
+
+
 /******************************************************************************/
 
 #define store_get_dns_answer() store_get_dns_answer_trc(CUS __FUNCTION__, __LINE__)
diff --git a/src/string.c b/src/string.c
index 49a028343..6fa01250f 100644
--- a/src/string.c
+++ b/src/string.c
@@ -12,7 +12,6 @@ utilities and tests, and are cut out by the COMPILE_UTILITY macro. */
 #include "exim.h"
 #include <assert.h>
 
-static void gstring_rebuffer(gstring * g);
 
 #ifndef COMPILE_UTILITY
 /*************************************************
@@ -1243,16 +1242,6 @@ return !!gp;
 
 
 
-/* Copy the content of a string to tainted memory */
-static void
-gstring_rebuffer(gstring * g)
-{
-uschar * s = store_get(g->size, TRUE);
-memcpy(s, g->s, g->ptr);
-g->s = s;
-}
-
-
 
 /* Build or append to a growing-string, sprintf-style.
 
-- 
2.25.1

