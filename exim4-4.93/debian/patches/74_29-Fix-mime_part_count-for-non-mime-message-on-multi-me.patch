From 1560edd9600ee87a18854a9bf8cdd68d54544205 Mon Sep 17 00:00:00 2001
From: Jeremy Harris <jgh146exb@wizmail.org>
Date: Sun, 1 Mar 2020 15:19:22 +0000
Subject: [PATCH 29/33] Fix $mime_part_count for non-mime message on
 multi-message connection.  Bug 2537

Cherry-picked from b273058b34
---
 doc/doc-docbook/spec.xfpt       |  17 ++-
 doc/ChangeLog           |   3 +
 src/receive.c               |   7 +
 test/confs/4001                 |  46 ++----
 test/confs/4002                 |  53 ++++---
 test/confs/4003                 |  13 +-
 test/confs/4015                 |  39 ++++-
 test/log/4001                   |   6 -
 test/log/4002                   |  19 +--
 test/log/4003                   |  17 ++-
 test/mail/4001.userx            |  33 -----
 test/runtest                    |   3 +
 test/scripts/4000-scanning/4001 | 104 +++++++++-----
 test/scripts/4000-scanning/4002 | 248 +++-----------------------------
 test/scripts/4000-scanning/4003 | 225 ++++++++++++++++++++++++++---
 test/stderr/4004                |   3 -
 test/stdout/4001                |  38 +++--
 test/stdout/4002                | 209 +--------------------------
 test/stdout/4003                | 216 +++++++++++++++++++++++++---
 19 files changed, 665 insertions(+), 634 deletions(-)
 mode change 120000 => 100644 test/confs/4015
 delete mode 100644 test/log/4001
 delete mode 100644 test/mail/4001.userx
 delete mode 100644 test/stderr/4004

diff --git a/doc/ChangeLog b/doc/ChangeLog
index e46e8c694..b87a32b8e 100644
--- a/doc/ChangeLog
+++ b/doc/ChangeLog
@@ -78,6 +78,9 @@ JH/28 Bug 2533: Fix expansion of ${tr } item.  When called in some situations
       it could crash from a null-deref.  This could also affect the
       ${addresses: } operator and ${readsock } item.
 
+JH/29 Bug 2537: Fix $mime_part_count.  When a single connection had a non-mime
+      message following a mime one, the variable was not reset.
+
 
 Exim version 4.93
 -----------------
diff --git a/src/receive.c b/src/receive.c
index 4e85ffacf..350c4eda8 100644
--- a/src/receive.c
+++ b/src/receive.c
@@ -1756,6 +1756,13 @@ if (thismessage_size_limit <= 0) thismessage_size_limit = INT_MAX;
 message_linecount = body_linecount = body_zerocount =
   max_received_linelength = 0;
 
+#ifdef WITH_CONTENT_SCAN
+/* reset non-per-part mime variables */
+mime_is_coverletter    = 0;
+mime_is_rfc822         = 0;
+mime_part_count        = -1;
+#endif
+
 #ifndef DISABLE_DKIM
 /* Call into DKIM to set up the context.  In CHUNKING mode
 we clear the dot-stuffing flag */
diff --git a/test/confs/4015 b/test/confs/4015
new file mode 100644
index 000000000..043a1eccb
-- 
2.25.1

